<!--pages/report/report.wxml-->
<view class="page">
  <!-- 自定义导航栏 -->
  <navigation-bar title="问题举报" show-back="{{true}}"></navigation-bar>

  <!-- 举报类型选择 -->
  <view class="report-types">
    <view class="section-header">
      <view class="section-title">举报类型</view>
      <view class="section-subtitle">请选择您要举报的问题类型</view>
    </view>
    
    <view class="types-grid">
      <view wx:for="{{reportTypes}}" wx:key="id" 
            class="type-item {{selectedType === item.id ? 'selected' : ''}}"
            bindtap="selectType" data-type="{{item}}">
        <view class="type-icon">{{item.icon}}</view>
        <view class="type-name">{{item.name}}</view>
        <view class="type-desc">{{item.description}}</view>
      </view>
    </view>
  </view>

  <!-- 详细信息 -->
  <view class="report-details">
    <view class="section-header">
      <view class="section-title">详细信息</view>
      <view class="section-subtitle">请详细描述您遇到的问题</view>
    </view>
    
    <view class="form-container">
      <!-- 问题标题 -->
      <view class="form-group">
        <view class="form-label">问题标题 <text class="required">*</text></view>
        <input class="form-input" 
               placeholder="请简要描述问题" 
               value="{{reportData.title}}"
               bindinput="onTitleInput" 
               maxlength="50" />
        <view class="input-counter">{{reportData.title.length}}/50</view>
      </view>
      
      <!-- 问题描述 -->
      <view class="form-group">
        <view class="form-label">问题描述 <text class="required">*</text></view>
        <textarea class="form-textarea" 
                  placeholder="请详细描述您遇到的问题，包括具体情况、发生时间等" 
                  value="{{reportData.description}}"
                  bindinput="onDescriptionInput" 
                  maxlength="500"
                  auto-height></textarea>
        <view class="input-counter">{{reportData.description.length}}/500</view>
      </view>
      
      <!-- 联系方式 -->
      <view class="form-group">
        <view class="form-label">联系方式</view>
        <input class="form-input" 
               placeholder="手机号或微信号（选填，便于我们联系您）" 
               value="{{reportData.contact}}"
               bindinput="onContactInput" 
               maxlength="20" />
      </view>
      
      <!-- 发生地点 -->
      <view class="form-group">
        <view class="form-label">发生地点</view>
        <view class="location-input" bindtap="chooseLocation">
          <input class="form-input" 
                 placeholder="点击选择地点" 
                 value="{{reportData.location}}"
                 disabled />
          <view class="location-icon">📍</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 上传证据 -->
  <view class="evidence-section">
    <view class="section-header">
      <view class="section-title">上传证据</view>
      <view class="section-subtitle">照片或视频有助于我们更好地处理问题</view>
    </view>
    
    <view class="upload-container">
      <view class="uploaded-files">
        <view wx:for="{{reportData.evidence}}" wx:key="index" class="file-item">
          <image wx:if="{{item.type === 'image'}}" src="{{item.url}}" class="file-preview" bindtap="previewImage" data-url="{{item.url}}"></image>
          <video wx:elif="{{item.type === 'video'}}" src="{{item.url}}" class="file-preview" controls></video>
          <view class="file-remove" bindtap="removeFile" data-index="{{index}}">×</view>
        </view>
        
        <view wx:if="{{reportData.evidence.length < 6}}" class="upload-btn" bindtap="chooseMedia">
          <view class="upload-icon">📷</view>
          <view class="upload-text">添加图片/视频</view>
          <view class="upload-hint">最多6张</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 紧急程度 -->
  <view class="urgency-section">
    <view class="section-header">
      <view class="section-title">紧急程度</view>
    </view>
    
    <view class="urgency-options">
      <view wx:for="{{urgencyLevels}}" wx:key="id" 
            class="urgency-item {{selectedUrgency === item.id ? 'selected' : ''}}"
            bindtap="selectUrgency" data-urgency="{{item}}">
        <view class="urgency-icon {{item.level}}">{{item.icon}}</view>
        <view class="urgency-content">
          <view class="urgency-name">{{item.name}}</view>
          <view class="urgency-desc">{{item.description}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 提交按钮 -->
  <view class="submit-section">
    <view class="submit-tips">
      <view class="tip-item">
        <view class="tip-icon">🔒</view>
        <view class="tip-text">您的信息将被严格保密</view>
      </view>
      <view class="tip-item">
        <view class="tip-icon">⚡</view>
        <view class="tip-text">我们会在24小时内处理</view>
      </view>
    </view>
    
    <button class="submit-btn" 
            bindtap="submitReport" 
            disabled="{{!canSubmit || submitting}}">
      <text class="btn-icon">{{submitting ? '⏳' : '📤'}}</text>
      {{submitting ? '提交中...' : '提交举报'}}
    </button>
  </view>

  <!-- 历史举报 -->
  <view class="history-section">
    <view class="section-header">
      <view class="section-title">我的举报</view>
      <view class="view-all" bindtap="viewAllReports">查看全部</view>
    </view>
    
    <view wx:if="{{reportHistory.length > 0}}" class="history-list">
      <view wx:for="{{reportHistory}}" wx:key="id" class="history-item" bindtap="viewReportDetail" data-report="{{item}}">
        <view class="history-content">
          <view class="history-title">{{item.title}}</view>
          <view class="history-status {{item.status}}">
            <text class="status-icon">{{getStatusIcon(item.status)}}</text>
            <text class="status-text">{{getStatusText(item.status)}}</text>
          </view>
          <view class="history-time">{{item.createTime}}</view>
        </view>
        <view class="history-arrow">›</view>
      </view>
    </view>
    
    <view wx:else class="empty-history">
      <view class="empty-icon">📝</view>
      <view class="empty-text">暂无举报记录</view>
    </view>
  </view>
</view>

<!-- 加载遮罩 -->
<view wx:if="{{showLoading}}" class="loading-overlay">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <view class="loading-text">{{loadingText}}</view>
  </view>
</view>