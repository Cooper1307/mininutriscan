<!--pages/detection/detection.wxml-->
<view class="page">
  <!-- 自定义导航栏 -->
  <navigation-bar title="AI智能检测" show-back="{{true}}"></navigation-bar>

  <!-- 检测区域 -->
  <view class="detection-area">
    <!-- 相机预览区 -->
    <view class="camera-container">
      <view wx:if="{{!selectedImage}}" class="camera-placeholder" bindtap="chooseImage">
        <view class="placeholder-icon">📷</view>
        <view class="placeholder-text">点击拍照或选择图片</view>
        <view class="placeholder-hint">支持JPG、PNG格式，建议清晰拍摄</view>
      </view>
      
      <view wx:else class="image-preview">
        <image src="{{selectedImage}}" mode="aspectFit" class="preview-image"></image>
        <view class="image-actions">
          <button class="action-btn secondary" bindtap="retakePhoto">
            <text class="icon">🔄</text>
            重新拍照
          </button>
          <button class="action-btn primary" bindtap="startDetection" disabled="{{detecting}}">
            <text class="icon">{{detecting ? '⏳' : '🔍'}}</text>
            {{detecting ? '检测中...' : '开始检测'}}
          </button>
        </view>
      </view>
    </view>

    <!-- 快速拍照选项 -->
    <view wx:if="{{!selectedImage}}" class="quick-options">
      <view class="option-item" bindtap="openCamera">
        <view class="option-icon">📸</view>
        <view class="option-text">拍照检测</view>
      </view>
      <view class="option-item" bindtap="chooseFromAlbum">
        <view class="option-icon">🖼️</view>
        <view class="option-text">相册选择</view>
      </view>
      <view class="option-item" bindtap="scanBarcode">
        <view class="option-icon">📊</view>
        <view class="option-text">扫描条码</view>
      </view>
    </view>
  </view>

  <!-- 检测进度 -->
  <view wx:if="{{detecting}}" class="detection-progress">
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{detectionProgress}}%"></view>
      </view>
      <view class="progress-text">{{detectionStatus}}</view>
    </view>
    
    <view class="detection-steps">
      <view class="step {{currentStep >= 1 ? 'active' : ''}}">
        <view class="step-icon">🔍</view>
        <view class="step-text">图像分析</view>
      </view>
      <view class="step {{currentStep >= 2 ? 'active' : ''}}">
        <view class="step-icon">🧠</view>
        <view class="step-text">AI识别</view>
      </view>
      <view class="step {{currentStep >= 3 ? 'active' : ''}}">
        <view class="step-icon">📊</view>
        <view class="step-text">结果分析</view>
      </view>
      <view class="step {{currentStep >= 4 ? 'active' : ''}}">
        <view class="step-icon">✅</view>
        <view class="step-text">检测完成</view>
      </view>
    </view>
  </view>

  <!-- 历史记录 -->
  <view class="history-section">
    <view class="section-header">
      <view class="section-title">最近检测</view>
      <view class="view-all" bindtap="viewAllHistory">查看全部</view>
    </view>
    
    <view wx:if="{{historyList.length > 0}}" class="history-list">
      <view wx:for="{{historyList}}" wx:key="id" class="history-item" bindtap="viewHistoryDetail" data-item="{{item}}">
        <image src="{{item.image}}" class="history-image"></image>
        <view class="history-content">
          <view class="history-title">{{item.foodName}}</view>
          <view class="history-result {{item.safetyLevel}}">
            <text class="result-icon">{{item.safetyIcon}}</text>
            <text class="result-text">{{item.safetyText}}</text>
          </view>
          <view class="history-time">{{item.detectionTime}}</view>
        </view>
        <view class="history-arrow">›</view>
      </view>
    </view>
    
    <view wx:else class="empty-history">
      <view class="empty-icon">📝</view>
      <view class="empty-text">暂无检测记录</view>
      <view class="empty-hint">开始您的第一次食品安全检测吧</view>
    </view>
  </view>

  <!-- 检测提示 -->
  <view class="tips-section">
    <view class="section-header">
      <view class="section-title">检测小贴士</view>
    </view>
    
    <view class="tips-list">
      <view class="tip-item">
        <view class="tip-icon">💡</view>
        <view class="tip-text">确保光线充足，避免阴影遮挡</view>
      </view>
      <view class="tip-item">
        <view class="tip-icon">📏</view>
        <view class="tip-text">保持适当距离，让食品完整入镜</view>
      </view>
      <view class="tip-item">
        <view class="tip-icon">🎯</view>
        <view class="tip-text">对焦清晰，避免模糊不清</view>
      </view>
      <view class="tip-item">
        <view class="tip-icon">🏷️</view>
        <view class="tip-text">包装食品请拍摄标签信息</view>
      </view>
    </view>
  </view>
</view>

<!-- 加载遮罩 -->
<view wx:if="{{showLoading}}" class="loading-overlay">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <view class="loading-text">{{loadingText}}</view>
  </view>
</view>