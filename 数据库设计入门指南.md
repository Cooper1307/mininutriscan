# 🗄️ 数据库设计入门指南 - 社区食安AI小卫士

> 专为新手设计的数据库教程，从概念到实践

## 📚 什么是数据库？

**简单理解：**
数据库就像一个超级整理柜，用来存储和管理我们小程序的所有数据：
- 用户信息（谁在使用我们的小程序）
- 举报记录（用户上传的食品安全问题）
- 营养分析结果（AI分析的食品营养信息）
- 志愿者信息（社区志愿者数据）

**为什么需要数据库？**
- 📱 小程序关闭后，数据不会丢失
- 🔍 可以快速查找和筛选信息
- 👥 多个用户可以同时使用
- 🔒 数据安全有保障

---

## 🏗️ 我们的数据库设计

### 核心数据表设计

我们的小程序需要以下几张"表"（可以理解为Excel的工作表）：

#### 1. 用户表 (users)
存储所有用户的基本信息

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | 整数 | 用户唯一编号 | 1, 2, 3... |
| openid | 文本 | 微信用户标识 | "ox1234567890" |
| nickname | 文本 | 用户昵称 | "张三" |
| avatar_url | 文本 | 头像链接 | "https://..." |
| phone | 文本 | 手机号 | "13812345678" |
| role | 文本 | 用户角色 | "user", "volunteer", "admin" |
| community_id | 整数 | 所属社区ID | 1, 2, 3... |
| created_at | 时间 | 注册时间 | "2024-01-15 10:30:00" |
| is_active | 布尔 | 是否激活 | true, false |

#### 2. 社区表 (communities)
存储社区信息

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | 整数 | 社区唯一编号 | 1, 2, 3... |
| name | 文本 | 社区名称 | "阳光花园社区" |
| address | 文本 | 社区地址 | "上海市普陀区..." |
| contact_person | 文本 | 联系人 | "李主任" |
| contact_phone | 文本 | 联系电话 | "021-12345678" |
| created_at | 时间 | 创建时间 | "2024-01-01 00:00:00" |

#### 3. 举报表 (reports)
存储用户举报的食品安全问题

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | 整数 | 举报唯一编号 | 1, 2, 3... |
| user_id | 整数 | 举报用户ID | 1 |
| title | 文本 | 举报标题 | "超市过期食品" |
| description | 文本 | 详细描述 | "发现某超市销售过期牛奶" |
| category | 文本 | 举报类别 | "过期食品", "无证经营" |
| location | 文本 | 举报地点 | "XX路XX号" |
| images | 文本 | 图片链接 | "[\"url1\", \"url2\"]" |
| status | 文本 | 处理状态 | "pending", "processing", "resolved" |
| priority | 文本 | 优先级 | "low", "medium", "high" |
| assigned_to | 整数 | 分配给志愿者ID | 2 |
| created_at | 时间 | 举报时间 | "2024-01-15 14:30:00" |
| updated_at | 时间 | 更新时间 | "2024-01-15 15:00:00" |

#### 4. 营养分析表 (nutrition_analyses)
存储AI分析的食品营养信息

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | 整数 | 分析记录ID | 1, 2, 3... |
| user_id | 整数 | 用户ID | 1 |
| food_name | 文本 | 食品名称 | "苹果" |
| image_url | 文本 | 食品图片 | "https://..." |
| ocr_text | 文本 | OCR识别文字 | "营养成分表：蛋白质..." |
| ai_analysis | 文本 | AI分析结果 | "{\"calories\": 52, ...}" |
| nutrition_score | 整数 | 营养评分 | 85 |
| health_advice | 文本 | 健康建议 | "适量食用，富含维生素C" |
| created_at | 时间 | 分析时间 | "2024-01-15 16:00:00" |

#### 5. 志愿者活动表 (volunteer_activities)
存储志愿者参与的活动

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | 整数 | 活动ID | 1, 2, 3... |
| volunteer_id | 整数 | 志愿者ID | 2 |
| activity_type | 文本 | 活动类型 | "举报处理", "科普宣传" |
| description | 文本 | 活动描述 | "处理食品安全举报" |
| hours | 小数 | 服务时长 | 2.5 |
| status | 文本 | 状态 | "completed", "in_progress" |
| created_at | 时间 | 创建时间 | "2024-01-15 09:00:00" |

---

## 💻 实际创建数据库

### 第一步：安装数据库相关包

打开命令行（确保在backend目录下，虚拟环境已激活）：

```bash
# 安装SQLAlchemy（数据库ORM工具）
pip install sqlalchemy

# 安装Alembic（数据库迁移工具）
pip install alembic

# 安装python-dotenv（环境变量管理）
pip install python-dotenv
```

### 第二步：创建数据库模型文件

在`backend`文件夹中创建文件：`models.py`

```python
# models.py - 数据库模型定义
from sqlalchemy import Column, Integer, String, Text, DateTime, Boolean, Float, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime

# 创建基础模型类
Base = declarative_base()

class Community(Base):
    """社区表"""
    __tablename__ = "communities"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False, comment="社区名称")
    address = Column(Text, comment="社区地址")
    contact_person = Column(String(50), comment="联系人")
    contact_phone = Column(String(20), comment="联系电话")
    created_at = Column(DateTime, default=datetime.utcnow, comment="创建时间")
    
    # 关联关系：一个社区有多个用户
    users = relationship("User", back_populates="community")

class User(Base):
    """用户表"""
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    openid = Column(String(100), unique=True, nullable=False, comment="微信openid")
    nickname = Column(String(50), comment="用户昵称")
    avatar_url = Column(Text, comment="头像URL")
    phone = Column(String(20), comment="手机号")
    role = Column(String(20), default="user", comment="用户角色：user/volunteer/admin")
    community_id = Column(Integer, ForeignKey("communities.id"), comment="所属社区ID")
    created_at = Column(DateTime, default=datetime.utcnow, comment="注册时间")
    is_active = Column(Boolean, default=True, comment="是否激活")
    
    # 关联关系
    community = relationship("Community", back_populates="users")
    reports = relationship("Report", back_populates="user")
    nutrition_analyses = relationship("NutritionAnalysis", back_populates="user")
    volunteer_activities = relationship("VolunteerActivity", back_populates="volunteer")

class Report(Base):
    """举报表"""
    __tablename__ = "reports"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, comment="举报用户ID")
    title = Column(String(200), nullable=False, comment="举报标题")
    description = Column(Text, comment="详细描述")
    category = Column(String(50), comment="举报类别")
    location = Column(Text, comment="举报地点")
    images = Column(Text, comment="图片链接JSON数组")
    status = Column(String(20), default="pending", comment="处理状态")
    priority = Column(String(10), default="medium", comment="优先级")
    assigned_to = Column(Integer, ForeignKey("users.id"), comment="分配给志愿者ID")
    created_at = Column(DateTime, default=datetime.utcnow, comment="举报时间")
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, comment="更新时间")
    
    # 关联关系
    user = relationship("User", back_populates="reports", foreign_keys=[user_id])
    assigned_volunteer = relationship("User", foreign_keys=[assigned_to])

class NutritionAnalysis(Base):
    """营养分析表"""
    __tablename__ = "nutrition_analyses"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, comment="用户ID")
    food_name = Column(String(100), comment="食品名称")
    image_url = Column(Text, comment="食品图片URL")
    ocr_text = Column(Text, comment="OCR识别的文字")
    ai_analysis = Column(Text, comment="AI分析结果JSON")
    nutrition_score = Column(Integer, comment="营养评分0-100")
    health_advice = Column(Text, comment="健康建议")
    created_at = Column(DateTime, default=datetime.utcnow, comment="分析时间")
    
    # 关联关系
    user = relationship("User", back_populates="nutrition_analyses")

class VolunteerActivity(Base):
    """志愿者活动表"""
    __tablename__ = "volunteer_activities"
    
    id = Column(Integer, primary_key=True, index=True)
    volunteer_id = Column(Integer, ForeignKey("users.id"), nullable=False, comment="志愿者ID")
    activity_type = Column(String(50), comment="活动类型")
    description = Column(Text, comment="活动描述")
    hours = Column(Float, comment="服务时长（小时）")
    status = Column(String(20), default="in_progress", comment="状态")
    created_at = Column(DateTime, default=datetime.utcnow, comment="创建时间")
    
    # 关联关系
    volunteer = relationship("User", back_populates="volunteer_activities")

# 如果直接运行这个文件，打印所有表结构
if __name__ == "__main__":
    print("📋 数据库表结构：")
    print("1. communities - 社区表")
    print("2. users - 用户表")
    print("3. reports - 举报表")
    print("4. nutrition_analyses - 营养分析表")
    print("5. volunteer_activities - 志愿者活动表")
    print("\n✅ 数据库模型定义完成！")
```

### 第三步：创建数据库连接文件

在`backend`文件夹中创建文件：`database.py`

```python
# database.py - 数据库连接和会话管理
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from models import Base
import os
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

# 获取数据库URL（从.env文件）
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./community_food_safety.db")

print(f"📊 使用数据库：{DATABASE_URL}")

# 创建数据库引擎
engine = create_engine(
    DATABASE_URL,
    # SQLite特殊配置
    connect_args={"check_same_thread": False} if "sqlite" in DATABASE_URL else {}
)

# 创建会话工厂
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def create_tables():
    """创建所有数据库表"""
    print("🏗️  正在创建数据库表...")
    Base.metadata.create_all(bind=engine)
    print("✅ 数据库表创建完成！")

def get_db():
    """获取数据库会话"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def init_sample_data():
    """初始化示例数据"""
    from models import Community, User
    
    db = SessionLocal()
    try:
        # 检查是否已有数据
        if db.query(Community).first():
            print("📋 数据库已有数据，跳过初始化")
            return
        
        print("🌱 正在初始化示例数据...")
        
        # 创建示例社区
        community1 = Community(
            name="阳光花园社区",
            address="上海市普陀区阳光路123号",
            contact_person="李主任",
            contact_phone="021-12345678"
        )
        
        community2 = Community(
            name="绿色家园社区",
            address="上海市普陀区绿色大道456号",
            contact_person="王主任",
            contact_phone="021-87654321"
        )
        
        db.add(community1)
        db.add(community2)
        db.commit()
        
        # 创建示例用户
        admin_user = User(
            openid="admin_test_openid",
            nickname="系统管理员",
            role="admin",
            community_id=community1.id,
            phone="13800138000"
        )
        
        volunteer_user = User(
            openid="volunteer_test_openid",
            nickname="志愿者小张",
            role="volunteer",
            community_id=community1.id,
            phone="13800138001"
        )
        
        normal_user = User(
            openid="user_test_openid",
            nickname="普通用户小李",
            role="user",
            community_id=community2.id,
            phone="13800138002"
        )
        
        db.add(admin_user)
        db.add(volunteer_user)
        db.add(normal_user)
        db.commit()
        
        print("✅ 示例数据初始化完成！")
        print(f"   - 创建了 {db.query(Community).count()} 个社区")
        print(f"   - 创建了 {db.query(User).count()} 个用户")
        
    except Exception as e:
        print(f"❌ 初始化数据失败：{str(e)}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    print("🚀 初始化数据库...")
    create_tables()
    init_sample_data()
    print("🎉 数据库初始化完成！")
```

### 第四步：创建数据库初始化脚本

在`backend`文件夹中创建文件：`init_database.py`

```python
# init_database.py - 数据库初始化脚本
from database import create_tables, init_sample_data
from models import *
import os

def main():
    print("🎯 社区食安AI小卫士 - 数据库初始化")
    print("=" * 50)
    
    try:
        # 1. 创建数据库表
        print("\n📋 步骤1：创建数据库表")
        create_tables()
        
        # 2. 初始化示例数据
        print("\n🌱 步骤2：初始化示例数据")
        init_sample_data()
        
        # 3. 验证数据库
        print("\n🔍 步骤3：验证数据库")
        verify_database()
        
        print("\n🎉 数据库初始化成功！")
        print("\n📝 接下来你可以：")
        print("   1. 运行 python main.py 启动API服务器")
        print("   2. 访问 http://localhost:8000/docs 查看API文档")
        print("   3. 开始开发小程序前端")
        
    except Exception as e:
        print(f"\n❌ 初始化失败：{str(e)}")
        print("\n🔧 请检查：")
        print("   1. .env文件是否正确配置")
        print("   2. 数据库连接是否正常")
        print("   3. 必要的Python包是否已安装")

def verify_database():
    """验证数据库是否正常"""
    from database import SessionLocal
    from models import Community, User
    
    db = SessionLocal()
    try:
        # 检查表是否存在且有数据
        community_count = db.query(Community).count()
        user_count = db.query(User).count()
        
        print(f"   ✅ 社区表：{community_count} 条记录")
        print(f"   ✅ 用户表：{user_count} 条记录")
        
        # 显示示例数据
        if community_count > 0:
            first_community = db.query(Community).first()
            print(f"   📍 示例社区：{first_community.name}")
        
        if user_count > 0:
            admin_user = db.query(User).filter(User.role == "admin").first()
            if admin_user:
                print(f"   👤 管理员：{admin_user.nickname}")
        
    except Exception as e:
        print(f"   ❌ 验证失败：{str(e)}")
        raise
    finally:
        db.close()

if __name__ == "__main__":
    main()
```

### 第五步：运行数据库初始化

在命令行中运行：

```bash
# 确保在backend目录下，虚拟环境已激活
python init_database.py
```

如果看到"🎉 数据库初始化成功！"，说明数据库创建成功！

### 第六步：验证数据库

创建一个简单的查询脚本来验证数据库：`test_database.py`

```python
# test_database.py - 测试数据库连接和查询
from database import SessionLocal
from models import Community, User, Report

def test_database():
    print("🧪 测试数据库连接和查询...")
    
    db = SessionLocal()
    try:
        # 查询所有社区
        communities = db.query(Community).all()
        print(f"\n📍 社区列表 ({len(communities)}个):")
        for community in communities:
            print(f"   - {community.name} ({community.address})")
        
        # 查询所有用户
        users = db.query(User).all()
        print(f"\n👥 用户列表 ({len(users)}个):")
        for user in users:
            print(f"   - {user.nickname} ({user.role}) - {user.community.name if user.community else '无社区'}")
        
        # 统计信息
        print(f"\n📊 数据统计:")
        print(f"   - 总社区数：{db.query(Community).count()}")
        print(f"   - 总用户数：{db.query(User).count()}")
        print(f"   - 管理员数：{db.query(User).filter(User.role == 'admin').count()}")
        print(f"   - 志愿者数：{db.query(User).filter(User.role == 'volunteer').count()}")
        print(f"   - 普通用户数：{db.query(User).filter(User.role == 'user').count()}")
        print(f"   - 举报记录数：{db.query(Report).count()}")
        
        print("\n✅ 数据库测试通过！")
        
    except Exception as e:
        print(f"❌ 数据库测试失败：{str(e)}")
    finally:
        db.close()

if __name__ == "__main__":
    test_database()
```

运行测试：
```bash
python test_database.py
```

---

## 🎯 数据库设计要点总结

### ✅ 我们完成了什么：

1. **设计了完整的数据库结构**
   - 5张核心数据表
   - 清晰的关联关系
   - 合理的字段类型

2. **创建了数据库模型**
   - 使用SQLAlchemy ORM
   - 定义了所有表结构
   - 建立了表之间的关系

3. **实现了数据库管理**
   - 自动创建表结构
   - 初始化示例数据
   - 数据库连接管理

4. **提供了测试工具**
   - 数据库连接测试
   - 数据查询验证
   - 错误诊断功能

### 🔑 关键概念理解：

- **主键 (Primary Key)**：每条记录的唯一标识
- **外键 (Foreign Key)**：连接不同表的桥梁
- **关联关系 (Relationship)**：表与表之间的逻辑连接
- **索引 (Index)**：提高查询速度的工具

### 📈 下一步计划：

1. **创建API接口**：让前端可以操作数据库
2. **实现用户认证**：微信登录和权限管理
3. **开发核心功能**：举报、分析、管理等
4. **集成AI服务**：OCR和智能问答

---

## 🆘 常见问题解决

### 问题1：数据库文件在哪里？
**答案**：SQLite数据库文件 `community_food_safety.db` 在backend目录下

### 问题2：如何查看数据库内容？
**答案**：
1. 下载 DB Browser for SQLite
2. 打开 `community_food_safety.db` 文件
3. 可以图形化查看和编辑数据

### 问题3：如何重置数据库？
**答案**：
```bash
# 删除数据库文件
del community_food_safety.db
# 重新初始化
python init_database.py
```

### 问题4：数据库连接失败？
**答案**：
1. 检查.env文件中的DATABASE_URL
2. 确保有写入权限
3. 检查SQLAlchemy是否正确安装

---

**🎉 恭喜！你已经成功设计和创建了项目数据库！**

**下一个文档：** `API接口开发指南.md`